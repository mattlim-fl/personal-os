name: Morning Briefing

on:
  schedule:
    # 7am London time (UTC in winter, UTC+1 in summer)
    - cron: '0 7 * * *' # Every day at 7am UTC
  workflow_dispatch: # Manual trigger for testing
    inputs:
      test_mode:
        description: 'Run in test mode (logs output instead of sending email)'
        required: false
        default: 'false'
        type: boolean

jobs:
  morning-briefing:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Notion Weekly Tracker
        id: notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const WEEKLY_TRACKER_PAGE_ID = '23ec73459c4180dca14bc0aa66f2b617';

            async function fetchNotion(endpoint, options = {}) {
              const response = await fetch(`https://api.notion.com/v1${endpoint}`, {
                ...options,
                headers: {
                  'Authorization': `Bearer ${process.env.NOTION_API_KEY}`,
                  'Notion-Version': '2022-06-28',
                  'Content-Type': 'application/json',
                  ...options.headers,
                },
              });

              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Notion API error: ${response.status} - ${error}`);
              }

              return response.json();
            }

            async function getBlockChildren(blockId) {
              const blocks = [];
              let cursor;

              do {
                const params = cursor ? `?start_cursor=${cursor}` : '';
                const response = await fetchNotion(`/blocks/${blockId}/children${params}`);
                blocks.push(...response.results);
                cursor = response.has_more ? response.next_cursor : undefined;
              } while (cursor);

              return blocks;
            }

            function extractText(richText) {
              return richText?.map(t => t.plain_text).join('') || '';
            }

            // Get yesterday's date for finding yesterday's outcomes
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toLocaleDateString('en-GB', {
              weekday: 'long',
              day: 'numeric',
              month: 'long'
            });

            // Fetch the page blocks
            console.log('Fetching Weekly Tracker page...');
            const blocks = await getBlockChildren(WEEKLY_TRACKER_PAGE_ID);

            const weeklyGoals = [];
            const goalSignals = [];
            const yesterdayIncomplete = [];

            let currentSection = '';
            let inYesterdaySection = false;

            for (const block of blocks) {
              // Detect section headers
              if (['heading_1', 'heading_2', 'heading_3'].includes(block.type)) {
                const text = extractText(block[block.type].rich_text).toLowerCase();

                if (text.includes('this week will be successful') || text.includes('weekly goal')) {
                  currentSection = 'weekly_goals';
                  inYesterdaySection = false;
                } else if (text.includes('goal signal')) {
                  currentSection = 'goal_signals';
                  inYesterdaySection = false;
                } else if (text.includes('daily outcome') || text.includes('outcome line')) {
                  currentSection = 'daily_outcomes';
                  inYesterdaySection = false;
                } else {
                  // Check if this is yesterday's date header
                  if (text.includes(yesterdayStr.toLowerCase())) {
                    inYesterdaySection = true;
                  } else if (block.type === 'heading_2' || block.type === 'heading_3') {
                    // Another date header - we've moved past yesterday
                    inYesterdaySection = false;
                  }
                }
                continue;
              }

              // Toggle blocks might contain daily content
              if (block.type === 'toggle') {
                const toggleText = extractText(block.toggle.rich_text).toLowerCase();
                if (toggleText.includes(yesterdayStr.toLowerCase())) {
                  // Fetch toggle contents
                  const toggleChildren = await getBlockChildren(block.id);
                  for (const child of toggleChildren) {
                    if (child.type === 'to_do' && !child.to_do.checked) {
                      yesterdayIncomplete.push(extractText(child.to_do.rich_text));
                    }
                  }
                }
              }

              // Process content based on current section
              if (currentSection === 'weekly_goals') {
                if (block.type === 'bulleted_list_item' || block.type === 'numbered_list_item') {
                  const text = extractText(block[block.type].rich_text);
                  if (text) weeklyGoals.push(text);
                } else if (block.type === 'paragraph') {
                  const text = extractText(block.paragraph.rich_text);
                  // Numbered goals like "1. Goal text"
                  if (text && /^\d+\./.test(text)) {
                    weeklyGoals.push(text);
                  }
                }
              }

              if (currentSection === 'goal_signals' && block.type === 'to_do') {
                goalSignals.push({
                  text: extractText(block.to_do.rich_text),
                  checked: block.to_do.checked || false,
                });
              }

              // Daily outcomes section with yesterday check
              if (currentSection === 'daily_outcomes' && inYesterdaySection && block.type === 'to_do') {
                if (!block.to_do.checked) {
                  yesterdayIncomplete.push(extractText(block.to_do.rich_text));
                }
              }
            }

            console.log('Weekly Goals:', weeklyGoals);
            console.log('Goal Signals:', goalSignals);
            console.log('Yesterday Incomplete:', yesterdayIncomplete);

            // Build HTML sections
            let weeklyGoalsHtml = '<h2>This Week\'s Goals</h2>';
            if (weeklyGoals.length > 0) {
              weeklyGoalsHtml += '<ol>';
              for (const goal of weeklyGoals) {
                weeklyGoalsHtml += `<li>${goal.replace(/^\d+\.\s*/, '')}</li>`;
              }
              weeklyGoalsHtml += '</ol>';
            } else {
              weeklyGoalsHtml += '<p style="color: #666;">No weekly goals found.</p>';
            }

            let goalSignalsHtml = '<h3>Goal Signals</h3>';
            if (goalSignals.length > 0) {
              goalSignalsHtml += '<ul style="list-style: none; padding-left: 0;">';
              for (const signal of goalSignals) {
                const icon = signal.checked ? '✅' : '⬜';
                goalSignalsHtml += `<li>${icon} ${signal.text}</li>`;
              }
              goalSignalsHtml += '</ul>';
            }

            let carriedOverHtml = '';
            if (yesterdayIncomplete.length > 0) {
              carriedOverHtml = '<h2>Carried Over from Yesterday</h2>';
              carriedOverHtml += '<ul>';
              for (const item of yesterdayIncomplete) {
                carriedOverHtml += `<li>⚠️ ${item}</li>`;
              }
              carriedOverHtml += '</ul>';
            }

            core.setOutput('weekly_goals_html', weeklyGoalsHtml);
            core.setOutput('goal_signals_html', goalSignalsHtml);
            core.setOutput('carried_over_html', carriedOverHtml);
            core.setOutput('weekly_goals_count', weeklyGoals.length);
            core.setOutput('incomplete_count', yesterdayIncomplete.length);

      - name: Fetch GitHub Data
        id: github-data
        env:
          GH_PAT_PERSONAL: ${{ secrets.GH_PAT_PERSONAL }}
        uses: actions/github-script@v7
        with:
          script: |
            const myUsername = 'mattlim-fl';

            async function fetchGitHub(url) {
              const response = await fetch(url, {
                headers: {
                  'Authorization': `Bearer ${process.env.GH_PAT_PERSONAL}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              if (!response.ok) {
                console.log(`GitHub API error for ${url}: ${response.status}`);
                return [];
              }
              return response.json();
            }

            // Get PRs where I'm requested as reviewer
            const reviewRequests = await fetchGitHub(
              `https://api.github.com/search/issues?q=type:pr+state:open+review-requested:${myUsername}`
            );

            // Get issues assigned to me
            const assignedIssues = await fetchGitHub(
              `https://api.github.com/search/issues?q=type:issue+state:open+assignee:${myUsername}`
            );

            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

            // Filter for stale issues (not updated in 3+ days)
            const staleIssues = (assignedIssues.items || []).filter(issue => {
              const updatedAt = new Date(issue.updated_at);
              return updatedAt < threeDaysAgo;
            });

            let needsAttentionHtml = '';

            const prItems = reviewRequests.items || [];
            if (prItems.length > 0) {
              needsAttentionHtml += '<h3>PRs Awaiting Your Review</h3><ul>';
              for (const pr of prItems) {
                const repoName = pr.repository_url.split('/').slice(-2).join('/');
                needsAttentionHtml += `<li><a href="${pr.html_url}">${repoName}#${pr.number}</a>: ${pr.title}</li>`;
              }
              needsAttentionHtml += '</ul>';
            }

            if (staleIssues.length > 0) {
              needsAttentionHtml += '<h3>Stale Issues (No updates in 3+ days)</h3><ul>';
              for (const issue of staleIssues) {
                const repoName = issue.repository_url.split('/').slice(-2).join('/');
                const daysSince = Math.floor((new Date() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));
                needsAttentionHtml += `<li><a href="${issue.html_url}">${repoName}#${issue.number}</a>: ${issue.title} <span style="color: #999;">(${daysSince} days)</span></li>`;
              }
              needsAttentionHtml += '</ul>';
            }

            if (!needsAttentionHtml) {
              needsAttentionHtml = '<p style="color: #666;">Nothing needs immediate attention.</p>';
            }

            core.setOutput('needs_attention_html', needsAttentionHtml);
            core.setOutput('pr_count', prItems.length);
            core.setOutput('stale_issue_count', staleIssues.length);

      - name: Generate Suggested Focus
        id: suggest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const weeklyGoalsHtml = `${{ steps.notion.outputs.weekly_goals_html }}`;
            const carriedOver = `${{ steps.notion.outputs.carried_over_html }}`;
            const needsAttention = `${{ steps.github-data.outputs.needs_attention_html }}`;

            const prompt = `Based on this morning briefing data, suggest 2-3 specific things to focus on today. Be concise and actionable.

            Weekly Goals:
            ${weeklyGoalsHtml}

            Carried over from yesterday:
            ${carriedOver || 'Nothing carried over.'}

            Needs attention:
            ${needsAttention}

            Provide a brief, prioritized list of what to focus on today. Consider: incomplete items should be addressed, PRs needing review are time-sensitive, and weekly goals provide direction.`;

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-20250514',
                  max_tokens: 300,
                  messages: [{ role: 'user', content: prompt }]
                })
              });

              const data = await response.json();
              const suggestion = data.content?.[0]?.text || 'Unable to generate suggestions.';
              core.setOutput('suggested_focus', suggestion);
            } catch (error) {
              console.log(`Error generating suggestions: ${error.message}`);
              core.setOutput('suggested_focus', 'Unable to generate suggestions.');
            }

      - name: Build Email Content
        id: email
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-GB', {
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            });

            const subject = `Morning Briefing — ${dateStr}`;

            const body = `
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;">
              <h1 style="border-bottom: 2px solid #333; padding-bottom: 10px;">Morning Briefing</h1>
              <p style="color: #666;">${dateStr}</p>

              <div style="margin: 24px 0;">
                ${{ steps.notion.outputs.weekly_goals_html }}
                ${{ steps.notion.outputs.goal_signals_html }}
              </div>

              ${{ steps.notion.outputs.carried_over_html }}

              <h2>Needs Attention</h2>
              ${{ steps.github-data.outputs.needs_attention_html }}

              <h2>Suggested Focus</h2>
              <div style="background: #f0f7ff; padding: 16px; border-left: 4px solid #4a90d9; margin: 16px 0;">
                <p style="margin: 0; white-space: pre-wrap;">${{ steps.suggest.outputs.suggested_focus }}</p>
              </div>

              <hr style="margin: 32px 0; border: none; border-top: 1px solid #eee;">
              <p style="color: #999; font-size: 12px;">Generated automatically at 7am</p>
            </div>
            `;

            core.setOutput('subject', subject);
            core.setOutput('body', body);

            // Log for test mode
            console.log('=== EMAIL PREVIEW ===');
            console.log('Subject:', subject);
            console.log('Body:', body);

      - name: Send Email
        if: ${{ github.event.inputs.test_mode != 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: lim.matthewjames@gmail.com
          from: lim.matthewjames@gmail.com
          html_body: ${{ steps.email.outputs.body }}
