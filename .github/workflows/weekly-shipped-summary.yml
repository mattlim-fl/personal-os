name: What Shipped This Week

on:
  schedule:
    # 7am London time (UTC in winter, UTC+1 in summer)
    # Using 7am UTC - will be 8am during BST
    - cron: '0 7 * * 5'  # Every Friday at 7am UTC
  workflow_dispatch:  # Manual trigger for testing

jobs:
  send-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout config
        uses: actions/checkout@v4
        with:
          sparse-checkout: config

      - name: Fetch data and generate per-project summaries
        id: fetch-data
        env:
          GITHUB_PAT_PERSONAL: ${{ secrets.PAT_PERSONAL }}
          GITHUB_PAT_FRACTAL: ${{ secrets.PAT_FRACTAL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./config/github-projects.json', 'utf8'));
            const projects = config.projects;

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const since = sevenDaysAgo.toISOString();
            const dateRange = `${sevenDaysAgo.toDateString()} to ${new Date().toDateString()}`;

            async function fetchGitHub(url, token) {
              const response = await fetch(url, {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
              }
              return response.json();
            }

            async function generateSummary(projectName, prList, commitList) {
              const prompt = `You are writing a brief weekly update summary for the "${projectName}" project.

            PRs merged this week:
            ${prList || 'None'}

            Commits this week:
            ${commitList || 'None'}

            Write a concise 2-3 sentence summary focusing on what was accomplished and its impact. Be specific about features/fixes. If nothing shipped, say "No updates this week." Keep it professional but friendly.`;

              try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': process.env.ANTHROPIC_API_KEY,
                    'anthropic-version': '2023-06-01'
                  },
                  body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 250,
                    messages: [{ role: 'user', content: prompt }]
                  })
                });

                const data = await response.json();
                return data.content?.[0]?.text || 'Unable to generate summary.';
              } catch (error) {
                console.log(`Error generating summary: ${error.message}`);
                return 'Unable to generate summary.';
              }
            }

            let detailHtml = '';
            let totalPRs = 0;
            let totalCommits = 0;

            for (const project of projects) {
              // Collect data from all repos in this project
              let projectPRs = [];
              let projectCommits = [];
              let repoDetails = [];
              let hasError = false;
              let errorMsg = '';

              for (const { owner, repo, label, tokenEnv } of project.repos) {
                const token = process.env[tokenEnv];
                const repoLabel = label || repo;

                try {
                  // Fetch merged PRs
                  const prs = await fetchGitHub(
                    `https://api.github.com/repos/${owner}/${repo}/pulls?state=closed&sort=updated&direction=desc&per_page=100`,
                    token
                  );

                  const mergedPRs = prs.filter(pr =>
                    pr.merged_at && new Date(pr.merged_at) >= sevenDaysAgo
                  );

                  // Fetch commits from default branch
                  const commits = await fetchGitHub(
                    `https://api.github.com/repos/${owner}/${repo}/commits?since=${since}&per_page=100`,
                    token
                  );

                  // Filter out merge commits
                  const directCommits = commits.filter(c =>
                    !c.commit.message.startsWith('Merge pull request') &&
                    !c.commit.message.startsWith('Merge branch')
                  );

                  // Add to project totals
                  projectPRs.push(...mergedPRs.map(pr => ({ ...pr, repoLabel, owner, repo })));
                  projectCommits.push(...directCommits.map(c => ({ ...c, repoLabel, owner, repo })));

                  // Store repo details for HTML
                  repoDetails.push({
                    owner, repo, label: repoLabel,
                    prs: mergedPRs,
                    commits: directCommits
                  });

                } catch (error) {
                  console.log(`Error fetching ${owner}/${repo}: ${error.message}`);
                  hasError = true;
                  errorMsg += `${repoLabel}: ${error.message}. `;
                }
              }

              totalPRs += projectPRs.length;
              totalCommits += projectCommits.length;

              // Build text for AI summary (combined across all repos)
              const prText = projectPRs.map(pr => `- PR #${pr.number}: ${pr.title}`).join('\n');
              const commitText = projectCommits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n');

              // Generate AI summary for this project
              const summary = await generateSummary(project.name, prText, commitText);

              // Build HTML for this project
              detailHtml += `<h2 style="margin-bottom: 5px;">${project.name}</h2>`;

              // List all repos in this project
              const repoLinks = project.repos.map(r =>
                `<a href="https://github.com/${r.owner}/${r.repo}">${r.label || r.repo}</a>`
              ).join(' Â· ');
              detailHtml += `<p style="color: #666; margin-top: 0;">${repoLinks}</p>`;

              // AI Summary for this project
              detailHtml += `<div style="background: #f8f9fa; padding: 12px 16px; border-left: 4px solid #4a90d9; margin: 16px 0;">`;
              detailHtml += `<p style="margin: 0; line-height: 1.5;">${summary}</p>`;
              detailHtml += `</div>`;

              if (hasError) {
                detailHtml += `<p style="color: #c00; font-size: 14px;">Errors: ${errorMsg}</p>`;
              }

              if (projectPRs.length === 0 && projectCommits.length === 0 && !hasError) {
                detailHtml += '<p style="color: #999;">No activity this week.</p>';
              } else if (repoDetails.length > 0) {
                // Collapsible details
                detailHtml += `<details style="margin-top: 12px;"><summary style="cursor: pointer; color: #666;">View details (${projectPRs.length} PRs, ${projectCommits.length} commits)</summary>`;

                // Group by repo if multiple repos
                for (const rd of repoDetails) {
                  if (rd.prs.length === 0 && rd.commits.length === 0) continue;

                  // Show repo label if project has multiple repos
                  if (project.repos.length > 1) {
                    detailHtml += `<h4 style="margin: 16px 0 8px 0; color: #333;">${rd.label}</h4>`;
                  }

                  if (rd.prs.length > 0) {
                    if (project.repos.length === 1) {
                      detailHtml += '<h4 style="margin: 12px 0 8px 0;">Pull Requests</h4>';
                    } else {
                      detailHtml += '<p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 14px;">Pull Requests</p>';
                    }
                    detailHtml += '<ul style="margin: 0;">';
                    for (const pr of rd.prs) {
                      detailHtml += `<li><a href="${pr.html_url}"><strong>#${pr.number}</strong> ${pr.title}</a> by @${pr.user.login}</li>`;
                    }
                    detailHtml += '</ul>';
                  }

                  if (rd.commits.length > 0) {
                    if (project.repos.length === 1) {
                      detailHtml += '<h4 style="margin: 12px 0 8px 0;">Commits</h4>';
                    } else {
                      detailHtml += '<p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 14px;">Commits</p>';
                    }
                    detailHtml += '<ul style="margin: 0;">';
                    for (const c of rd.commits) {
                      const shortSha = c.sha.substring(0, 7);
                      const message = c.commit.message.split('\n')[0];
                      const author = c.author?.login || c.commit.author.name;
                      detailHtml += `<li><a href="${c.html_url}"><code>${shortSha}</code></a> ${message} by @${author}</li>`;
                    }
                    detailHtml += '</ul>';
                  }
                }

                detailHtml += '</details>';
              }

              detailHtml += '<hr style="margin: 24px 0;">';
            }

            core.setOutput('detail_html', detailHtml);
            core.setOutput('summary', `${totalPRs} PRs, ${totalCommits} commits`);
            core.setOutput('date_range', dateRange);

      - name: Send email via Gmail SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "What Shipped This Week (${{ steps.fetch-data.outputs.summary }})"
          to: lim.matthewjames@gmail.com
          from: lim.matthewjames@gmail.com
          html_body: |
            <h1>What Shipped This Week</h1>
            <p style="color: #666;">${{ steps.fetch-data.outputs.date_range }}</p>
            <hr style="margin: 24px 0;">
            ${{ steps.fetch-data.outputs.detail_html }}
            <p style="color: #999; font-size: 12px;">Generated by Claude</p>
