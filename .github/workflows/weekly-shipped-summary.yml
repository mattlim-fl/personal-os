name: What Shipped This Week

on:
  schedule:
    # 7am London time (UTC in winter, UTC+1 in summer)
    # Using 7am UTC - will be 8am during BST
    - cron: '0 7 * * 5'  # Every Friday at 7am UTC
  workflow_dispatch:  # Manual trigger for testing

jobs:
  send-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch PRs and commits from last 7 days
        id: fetch-data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_PERSONAL }}
          script: |
            const owner = 'mattlim-fl';
            const repo = 'gm-dashboard';

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const since = sevenDaysAgo.toISOString();

            // Fetch merged PRs
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            const mergedPRs = prs.filter(pr =>
              pr.merged_at && new Date(pr.merged_at) >= sevenDaysAgo
            );

            // Fetch commits from default branch
            const { data: commits } = await github.rest.repos.listCommits({
              owner,
              repo,
              since,
              per_page: 100
            });

            // Filter out merge commits (they start with "Merge")
            const directCommits = commits.filter(c =>
              !c.commit.message.startsWith('Merge pull request') &&
              !c.commit.message.startsWith('Merge branch')
            );

            // Build email content
            let html = '<h1>What Shipped This Week</h1>';
            html += `<p><strong>${owner}/${repo}</strong> &mdash; ${sevenDaysAgo.toDateString()} to ${new Date().toDateString()}</p>`;
            html += '<hr>';

            // PRs section
            html += '<h2>Pull Requests</h2>';
            if (mergedPRs.length === 0) {
              html += '<p style="color: #666;">No PRs were merged this week.</p>';
            } else {
              html += '<ul>';
              for (const pr of mergedPRs) {
                html += `<li><a href="${pr.html_url}"><strong>#${pr.number}</strong> ${pr.title}</a> by @${pr.user.login}</li>`;
              }
              html += '</ul>';
            }

            // Commits section
            html += '<h2>Commits</h2>';
            if (directCommits.length === 0) {
              html += '<p style="color: #666;">No direct commits this week.</p>';
            } else {
              html += '<ul>';
              for (const c of directCommits) {
                const shortSha = c.sha.substring(0, 7);
                const message = c.commit.message.split('\n')[0]; // First line only
                const author = c.author?.login || c.commit.author.name;
                html += `<li><a href="${c.html_url}"><code>${shortSha}</code></a> ${message} by @${author}</li>`;
              }
              html += '</ul>';
            }

            const totalItems = mergedPRs.length + directCommits.length;
            core.setOutput('email_body', html);
            core.setOutput('summary', `${mergedPRs.length} PRs, ${directCommits.length} commits`);
            core.setOutput('total', totalItems);

      - name: Send email via Gmail SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "What Shipped This Week (${{ steps.fetch-data.outputs.summary }})"
          to: lim.matthewjames@gmail.com
          from: lim.matthewjames@gmail.com
          html_body: ${{ steps.fetch-data.outputs.email_body }}
