name: What Shipped This Week

on:
  schedule:
    # 7am London time (UTC in winter, UTC+1 in summer)
    # Using 7am UTC - will be 8am during BST
    - cron: '0 7 * * 5'  # Every Friday at 7am UTC
  workflow_dispatch:  # Manual trigger for testing

jobs:
  send-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch PRs and commits from all repos
        id: fetch-data
        env:
          GH_PAT_PERSONAL: ${{ secrets.GH_PAT_PERSONAL }}
          PAT_FRACTAL: ${{ secrets.PAT_FRACTAL }}
        uses: actions/github-script@v7
        with:
          script: |
            // === CONFIGURE YOUR REPOS HERE ===
            // Each repo specifies which PAT env var to use
            const repos = [
              { owner: 'mattlim-fl', repo: 'gm-dashboard', name: 'GM Dashboard', tokenEnv: 'GH_PAT_PERSONAL' },
              { owner: 'FractalLabsDev', repo: 'practice-interviews-web', name: 'Practice Interviews', tokenEnv: 'PAT_FRACTAL' },
            ];

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const since = sevenDaysAgo.toISOString();

            async function fetchGitHub(url, token) {
              const response = await fetch(url, {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
              }
              return response.json();
            }

            let allPrText = '';
            let allCommitText = '';
            let detailHtml = '';
            let totalPRs = 0;
            let totalCommits = 0;

            for (const { owner, repo, name, tokenEnv } of repos) {
              const token = process.env[tokenEnv];

              try {
                // Fetch merged PRs
                const prs = await fetchGitHub(
                  `https://api.github.com/repos/${owner}/${repo}/pulls?state=closed&sort=updated&direction=desc&per_page=100`,
                  token
                );

                const mergedPRs = prs.filter(pr =>
                  pr.merged_at && new Date(pr.merged_at) >= sevenDaysAgo
                );

                // Fetch commits from default branch
                const commits = await fetchGitHub(
                  `https://api.github.com/repos/${owner}/${repo}/commits?since=${since}&per_page=100`,
                  token
                );

                // Filter out merge commits
                const directCommits = commits.filter(c =>
                  !c.commit.message.startsWith('Merge pull request') &&
                  !c.commit.message.startsWith('Merge branch')
                );

                totalPRs += mergedPRs.length;
                totalCommits += directCommits.length;

                // Build text for AI summary
                if (mergedPRs.length > 0 || directCommits.length > 0) {
                  allPrText += `\n${name}:\n`;
                  if (mergedPRs.length > 0) {
                    allPrText += mergedPRs.map(pr => `- PR #${pr.number}: ${pr.title}`).join('\n') + '\n';
                  }
                  allCommitText += `\n${name}:\n`;
                  if (directCommits.length > 0) {
                    allCommitText += directCommits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n') + '\n';
                  }
                }

                // Build HTML for this repo
                detailHtml += `<h2>${name}</h2>`;
                detailHtml += `<p style="color: #666; margin-top: -10px;"><a href="https://github.com/${owner}/${repo}">${owner}/${repo}</a></p>`;

                if (mergedPRs.length === 0 && directCommits.length === 0) {
                  detailHtml += '<p style="color: #999;">No activity this week.</p>';
                } else {
                  if (mergedPRs.length > 0) {
                    detailHtml += '<h3>Pull Requests</h3><ul>';
                    for (const pr of mergedPRs) {
                      detailHtml += `<li><a href="${pr.html_url}"><strong>#${pr.number}</strong> ${pr.title}</a> by @${pr.user.login}</li>`;
                    }
                    detailHtml += '</ul>';
                  }

                  if (directCommits.length > 0) {
                    detailHtml += '<h3>Commits</h3><ul>';
                    for (const c of directCommits) {
                      const shortSha = c.sha.substring(0, 7);
                      const message = c.commit.message.split('\n')[0];
                      const author = c.author?.login || c.commit.author.name;
                      detailHtml += `<li><a href="${c.html_url}"><code>${shortSha}</code></a> ${message} by @${author}</li>`;
                    }
                    detailHtml += '</ul>';
                  }
                }

                detailHtml += '<hr>';

              } catch (error) {
                console.log(`Error fetching ${owner}/${repo}: ${error.message}`);
                detailHtml += `<h2>${name}</h2>`;
                detailHtml += `<p style="color: #c00;">Error fetching data: ${error.message}</p><hr>`;
              }
            }

            core.setOutput('pr_text', allPrText || 'No PRs this week');
            core.setOutput('commit_text', allCommitText || 'No commits this week');
            core.setOutput('detail_html', detailHtml);
            core.setOutput('summary', `${totalPRs} PRs, ${totalCommits} commits`);
            core.setOutput('date_range', `${sevenDaysAgo.toDateString()} to ${new Date().toDateString()}`);

      - name: Generate AI summary with Claude
        id: ai-summary
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_TEXT="${{ steps.fetch-data.outputs.pr_text }}"
          COMMIT_TEXT="${{ steps.fetch-data.outputs.commit_text }}"

          PROMPT="You are summarizing what shipped this week across multiple projects for a developer's personal digest email.

          Here are the PRs merged this week:
          $PR_TEXT

          Here are the commits this week:
          $COMMIT_TEXT

          Write a brief, friendly 3-4 sentence summary of what was accomplished across all projects. Group related work if it spans projects. Focus on impact, not just listing changes. If nothing shipped, say so briefly. Keep it concise and conversational."

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 300,
              "messages": [{"role": "user", "content": $prompt}]
            }')")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.content[0].text // "Unable to generate summary."')

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send email via Gmail SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "What Shipped This Week (${{ steps.fetch-data.outputs.summary }})"
          to: lim.matthewjames@gmail.com
          from: lim.matthewjames@gmail.com
          html_body: |
            <h1>What Shipped This Week</h1>
            <p>${{ steps.fetch-data.outputs.date_range }}</p>
            <hr>
            <h2>Summary</h2>
            <p style="font-size: 16px; line-height: 1.5;">${{ steps.ai-summary.outputs.summary }}</p>
            <hr>
            ${{ steps.fetch-data.outputs.detail_html }}
            <p style="color: #999; font-size: 12px;">Generated by Claude</p>
